# Core 层接口定义

本文档描述了 `core/` 模块的关键接口和与其他层的交互。Core 层包含核心游戏逻辑，负责实现不依赖于具体数据存储或外部框架的游戏核心规则和计算。它操作 `models` 中的数据对象，并被 `services` 层调用。

## `core/` 目录结构

`core/` 目录下包含以下主要文件和子目录：

*   `game_logic.py`: 游戏流程协调器，编排服务调用以完成复杂的游戏流程（如战斗、捕捉）。
*   `battle/`: 包含所有与战斗相关的纯逻辑计算和规则实现。
*   `pet/`: 包含所有与宝可梦个体相关的纯逻辑计算和规则实现（如技能、成长、捕捉、进化等）。
*   `pokemon_factory.py`: 根据元数据创建宝可梦实例的逻辑。

## Core 模块职责

Core 模块的主要职责包括：

1.  **实现纯游戏逻辑:** 包含游戏的核心规则、计算公式和状态转换逻辑，不涉及数据持久化或外部交互。
2.  **操作数据模型:** 直接操作 `models/` 目录中定义的数据对象，进行计算和状态更新。
3.  **提供可复用逻辑:** 提供可以被不同服务或流程调用的独立逻辑单元。

## 关键功能描述 (示例性描述，具体功能根据文件和需求定义)

Core 模块中的文件和子目录提供以下关键功能：

### `core/game_logic.py`

*   **职责:** 协调和组织跨多个服务或核心逻辑模块的游戏流程。例如，一个复杂任务的完成可能需要调用玩家服务、物品服务和对话服务，`game_logic.py` 负责按顺序调用这些服务并处理它们之间的逻辑。
*   **关键交互:** 被 `services/` 层调用，调用 `services/` 层中的方法。

### `core/battle/`

*   **职责:** 实现所有战斗相关的计算和规则，例如伤害计算、状态效果应用、场地效果影响、遭遇概率计算等。
*   **关键文件:**
    *   `battle_logic.py`: 核心战斗回合逻辑和流程。
    *   `encounter_logic.py`: 决定在特定地点是否遭遇宝可梦以及遭遇何种宝可梦的逻辑。
    *   `formulas.py`: 存放各种战斗相关的计算公式（伤害、命中、暴击等）。
    *   `field_effect.py`: 场地效果的具体逻辑实现。
    *   `status_effect.py`: 状态效果的具体逻辑实现。
*   **关键交互:** 被 `services/pokemon_service.py` (用于捕捉/遭遇) 和可能的 `services/battle_service.py` (如果存在) 调用。操作 `models/` 中的宝可梦、技能、状态等对象。

### `core/pet/`

*   **职责:** 实现所有与宝可梦个体相关的逻辑，例如技能学习、经验值计算、升级、进化条件判断、捕捉成功率计算、道具对宝可梦的影响等。
*   **关键文件:**
    *   `pet_skill.py`: 宝可梦技能的学习、遗忘、使用逻辑。
    *   `pet_grow.py`: 经验值计算、升级、属性成长逻辑。
    *   `pet_catch.py`: 宝可梦捕捉成功率计算逻辑。
    *   `pet_evolution.py`: 宝可梦进化条件判断和进化逻辑。
    *   `pet_item.py`: 道具对宝可梦的影响逻辑。
    *   `pet_system.py`: 宝可梦系统的通用逻辑。
*   **关键交互:** 被 `services/pokemon_service.py` 和 `services/item_service.py` 调用。操作 `models/` 中的宝可梦、道具等对象。

### `core/pokemon_factory.py`

*   **职责:** 根据宝可梦种类元数据和其他参数（如等级、性格等）创建具体的宝可梦实例 (`models.Pokemon` 对象)。
*   **关键交互:** 被 `services/pokemon_service.py` (在捕捉或生成宝可梦时) 调用。依赖 `metadata_service` 获取宝可梦种类数据。

## 接口定义 / 关键交互

*   **被调用:** 主要被 `services/` 层中的服务方法调用。
*   **调用:** 调用 `models/` 中的数据对象的方法或访问其属性。`game_logic.py` 会调用 `services/` 层的方法。
*   **依赖:** 依赖于 `models/` 模块。`game_logic.py` 依赖于 `services/` 模块。 

# Core API 文档

`backend/core/` 目录包含了插件的核心游戏逻辑实现。这一层是整个插件的大脑，负责处理游戏规则、计算、状态管理等。它应该独立于数据存储和外部框架（如 AstrBot API）。

## 模块概览

### `core/battle/`

*   **职责:** 实现所有与战斗相关的核心逻辑，包括战斗回合处理、行动执行、伤害计算、状态效果、场地效果、遭遇逻辑等。
*   **关键文件:**
    *   `battle_logic.py`: 核心战斗回合流程管理，行动分发，事件发布。负责协调回合流程并在适当时机调用状态效果处理器。
    *   `encounter_logic.py`: 决定在特定地点是否遭遇宝可梦以及遭遇何种宝可梦的逻辑。
    *   `formulas.py`: 存放各种战斗相关的计算公式（伤害、命中、暴击、混乱自伤等）。
    *   `field_effect.py`: 场地效果的具体逻辑实现。
    *   `status_effect.py`: 实现状态效果处理的通用机制，包括：
        * 状态和易变状态的施加与移除
        * 状态免疫检查（基于道具、特性和属性）
        * 回合开始时易变状态的触发逻辑（如畏缩、混乱）
        * 回合结束时状态持续回合的管理（减少回合数并移除到期状态）
        * 使用策略模式处理不同类型的易变状态
*   **关键交互:** 被 `services/pokemon_service.py` (用于捕捉/遭遇) 和可能的 `services/battle_service.py` (如果存在) 调用。操作 `models/` 中的宝可梦、技能、状态等对象。

### `core/pet/`

*   **职责:** 实现所有与宝可梦个体相关的逻辑，例如技能学习、经验值计算、升级、进化条件判断、捕捉成功率计算、道具对宝可梦的影响等。
*   **关键文件:**
    *   `pet_skill.py`: 宝可梦技能的学习、遗忘、使用逻辑。
    *   `pet_grow.py`: 经验值计算、升级、属性成长逻辑。
    *   `pet_catch.py`: 宝可梦捕捉成功率计算逻辑。
    *   `pet_evolution.py`: 宝可梦进化条件判断和进化逻辑。
    *   `pet_item.py`: 道具对宝可梦的影响逻辑。
    *   `pet_system.py`: 宝可梦系统的通用逻辑。
*   **关键交互:** 被 `services/pokemon_service.py` 和 `services/item_service.py` 调用。操作 `models/` 中的宝可梦、道具等对象。

## 总结

我们实现了一个通用的易变状态处理机制 