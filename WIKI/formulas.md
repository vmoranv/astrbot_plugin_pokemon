# 游戏计算公式设计

本文档描述了插件中使用的各种游戏计算公式，主要集中在 `core/formulas.py` 模块。

## 伤害计算公式

### 基本伤害计算

这是宝可梦对战中计算技能造成伤害的基础公式。

`伤害 = (((等级 * 2 / 5 + 2) * 技能威力 * 攻击属性 / 防御属性) / 50 + 2) * 修正`

*   **等级:** 攻击方宝可梦的当前等级。
*   **技能威力:** 使用的技能的基础威力。
*   **攻击属性:**
    *   如果技能是物理攻击，使用攻击方宝可梦的物理攻击属性值。
    *   如果技能是特殊攻击，使用攻击方宝可梦的特殊攻击属性值。
*   **防御属性:**
    *   如果技能是物理攻击，使用防守方宝可梦的物理防御属性值。
    *   如果技能是特殊攻击，使用防守方宝可梦的特殊防御属性值。
*   **修正:** 一个乘数，由多种因素组成，包括：
    *   **属性克制:** 根据技能属性和防守方宝可梦的属性计算（例如，2x, 1x, 0.5x, 0x）。
    *   **同属性攻击加成 (STAB):** 如果技能属性与攻击方宝可梦的属性之一相同，伤害乘以 1.5。
    *   **会心一击:** 如果发生会心一击，伤害乘以 1.5 (在某些世代是 2)。
    *   **随机数:** 一个介于 0.85 到 1.0 之间的随机乘数。
    *   **天气:** 特定天气可能增强或削弱特定属性的技能。
    *   **道具:** 某些道具可能影响伤害。
    *   **特性:** 某些宝可梦特性可能影响伤害。
    *   **场地效果:** 某些场地效果可能影响伤害。
    *   **其他因素:** 如光墙、反射壁、灼伤状态等。

### 修正计算示例

`修正 = 属性克制 * STAB * 会心一击 * 随机数 * 天气修正 * 道具修正 * 特性修正 * 场地效果修正 * ...`

## 经验值计算公式

(待补充，根据具体游戏世代或设计需求添加)

## 属性计算公式

(待补充，根据宝可梦种类、等级、个体值、努力值、性格等计算最终属性)

## 捕捉率计算公式

(待补充，根据宝可梦种类、当前 HP、状态、使用的精灵球等计算捕捉成功率)

## 其他公式

(根据游戏需要添加其他计算公式，例如：进化条件判断、状态效果持续回合计算等)

## 接口定义 / 关键交互

`core/formulas.py` 模块应提供一系列纯函数，接收计算所需的参数（通常是 models 层对象或基本数据类型），并返回计算结果。这些函数应是无副作用的。

*   **调用关系:** 主要被 `core/game_logic.py` 或其子模块（如 `core/battle/battle_logic.py`）调用。 

# Formulas 接口定义

本文档描述了 `core/battle/formulas.py` 文件的关键接口。`formulas.py` 负责存放游戏中所有核心的计算公式，例如战斗伤害计算、经验值计算、属性计算等。

## `core/battle/formulas.py`

**职责:** 集中管理游戏中各种数值计算的公式实现。这些公式是纯函数，只依赖于输入参数进行计算，不涉及状态修改或数据持久化。

**关键功能:**

`formulas.py` 提供一系列函数，每个函数实现一个特定的计算公式。这些函数通常接收游戏相关的数值或模型对象作为输入，并返回计算结果。

*   **战斗伤害计算:** 根据攻击方和防守方的属性、技能威力、属性克制、状态效果、场地效果等因素计算造成的伤害值。
*   **经验值计算:** 根据击败的宝可梦等级、玩家等级、战斗类型等计算获得的经验值。
*   **属性值计算:** 根据宝可梦种类基础属性、个体值、努力值、等级、性格等计算宝可梦的实际战斗属性值（HP, 攻击, 防御, 特攻, 特防, 速度）。
*   **捕捉成功率计算:** 根据目标宝可梦的种类、当前 HP、使用的精灵球类型、状态效果等计算捕捉成功的概率。
*   **其他计算:** 可能包括状态效果持续回合计算、场地效果持续回合计算、遇敌概率计算、暴击率计算、命中率计算等。

**接口定义 (示例性描述，具体函数根据游戏需求定义):**

*   `calculate_damage(...) -> int`: 计算伤害。
*   `calculate_exp_gain(...) -> int`: 计算经验值获取。
*   `calculate_stat_value(...) -> int`: 计算宝可梦属性值。
*   `calculate_catch_rate(...) -> float`: 计算捕捉成功率。

**调用关系:**

*   主要被 `core/battle/battle_logic.py`、`core/pet/pet_grow.py`、`core/pet/pet_catch.py` 等 Core 模块中的逻辑函数调用。
*   可能被 `services/` 层中的服务方法直接调用，如果该计算不属于某个 Core 逻辑模块的内部细节。 